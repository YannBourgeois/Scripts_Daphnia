### Remove remaining adapters with Trimmomatic, v0.33. Scripts executed in UNIX shell.
mkdir untrimmed
mv *fq.gz untrimmed
for i in ./untrimmed/*.fq.gz
do java -Xmx5G -Xmx5G -jar ./Trimmomatic-0.33/trimmomatic-0.33.jar SE -phred33 $i trimmed_$i ILLUMINACLIP:./Trimmomatic-0.33/adapters/TruSeq2-SE.fa:2:30:10
done

### Index reference genome (Zosterops.fsa)
#If multiline fasta, use this awk script so each scaffold consists of two lines (header+sequence)
# awk '/^>/ {printf("\n%s\n",$0);next; } { printf("%s",$0);}  END {printf("\n");}' < file_to_split.fsa > file_splitted.fsa
bwa index Zosterops.fsa

### Perform alignment with BWA MEM (ALN is now deprecated)
##For Cornell's GBS data (single end sequencing)

for i in *.fq.gz
do bwa mem Zosterops_genome.fsa -t 8  $i -M | samtools view -q 20 -bS - | samtools sort -  $i
done

#Note: If you have an access to a cluster, you can submit one job for each of the N alignments like this:
for i in *.fq.gz
do echo "bwa mem Zosterops_genome.fsa -t 8"  $i "-M | samtools view -q 20 -bS - | samtools sort -"  $i >> command_file
done
#Split the previous file in individual jobs and submit them
split -l1 command_file alignment.sh
for i in alignment.sh*
do qsub $i
done


## For paired-end sequencing (Shotgun sequencing + Pooled RAD-sequencing data). Assuming your files are named Ind1.R1.fq.gz and Ind2.R2.fq.gz.

for R1 in *.R1.fastq.gz
do
  Name=${R1%.R1*}
  bwa mem Zosterops_genome.fsa -t 8 "${Name}.R1.fastq.gz"  "${Name}.R2.fastq.gz" -M | samtools view -q 20 -bS - | samtools sort -  $Name 
done

#Note: Again, if you want to submit one job for each alignment:
for R1 in *.R1.fastq.gz
do
  Name=${R1%.R1*}
  echo "bwa mem Zosterops_genome.fsa -t 8" "${Name}.R1.fastq.gz"  "${Name}.R2.fastq.gz" "-M | samtools view -q 20 -bS - | samtools sort -"  $Name >> command_file 
done

split -l1 command_file alignment.sh
for i in alignment.sh*
do qsub $i
done
# move all bam in bam_with_duplicates directory
mkdir bam_with_duplicates
mv *bam bam_with_duplicates
### Add read group and remove duplicates. Use bamaddrg from bamtools (Erik Garrison)

for bam in ./bam_with_duplicates/*bam
do
	Name=${bam%.bam}
	echo "./bamaddrg -b" $bam "-s" $Name "| ./samtools-0.1.19/samtools rmdup - " ${Name}_rmdup.bam >> command_file_rmdup
done
split -l1 command_file_rmdup rmdup.sh
for i in rmdup.sh*
do qsub $i
done

### SNP calling using freeBayes (Erik Garrison)
## To speed up the process (for whole genome sequencing), it is recommended to run several small jobs on portions of the genome (-t option in freebayes).
## For this, bed files listing all scaffolds and regions to be covered 
## need to be provided. This can also be used to call SNPs only on a few regions of interests. 
## To get lengths of all the scaffolds in a reference fasta file file.fa, run:
awk '/^>/ {if (seqlen){print seqlen};print;seqtotal+=seqlen;seqlen=0;seq+=1;next;}
    {seqlen=seqlen+length($0)}
    END{print seqlen;print seq" sequences, total length " seqtotal+seqlen}' file.fa

## Then for each bed file (format: sequence_name	start_pos	end_pos):
## To list all bam files on one single line:
ls *bam | tr "\n" " " 
## This gives a list,e.g.: file1.bam file2.bam file3.bam
## Then copy and paste so you call SNPs on all bam files:

./freebayes -f Zosterops_genome.fsa file1.bam file2.bam file3.bam -t file_1.bed --genotype-qualities > SNPs_raw_1.vcf

### SNP filtering


